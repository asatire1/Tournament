<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mexicano Padel - Stretford Padel</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        * { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        body { font-family: 'Space Grotesk', -apple-system, BlinkMacSystemFont, sans-serif; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-slide-up { animation: slideUp 0.4s ease-out both; }
        .animate-scale-in { animation: scaleIn 0.3s ease-out; }
        
        .tab-active { background: linear-gradient(135deg, #14B8A6 0%, #0D9488 100%); color: white; box-shadow: 0 4px 12px rgba(20, 184, 166, 0.3); }
        .tab-inactive { background: transparent; color: #6B7280; }
        .tab-inactive:hover { background: #F3F4F6; }
        
        .match-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); background: white; border-radius: 16px; overflow: hidden; border: 1px solid rgba(0, 0, 0, 0.06); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06); border-left: 3px solid #14B8A6; }
        .match-card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); }
        .match-card.complete { background: linear-gradient(135deg, #F0FDF4 0%, #DCFCE7 100%); border-left-color: #16A34A; }
        
        .player-badge-compact { width: 100%; max-width: 140px; padding: 7px 12px; border-radius: 100px; font-size: 0.875rem; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12); color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .team-stack { display: flex; flex-direction: column; align-items: center; gap: 6px; flex: 1; min-width: 0; }
        .team-stack.winner .player-badge-compact { transform: scale(1.02); }
        
        .score-box-horizontal { min-width: 150px; height: 68px; display: flex; align-items: center; justify-content: center; gap: 3px; background: #f3f4f6; padding: 8px; border-radius: 12px; flex-shrink: 0; }
        .score-box-horizontal.score-complete { background: linear-gradient(135deg, #DCFCE7 0%, #BBF7D0 100%); border: 1px solid rgba(22, 163, 74, 0.2); }
        
        .score-input-compact { font-size: 1.75rem; font-weight: 700; text-align: center; border: none; background: transparent; width: 50px; color: #1F2937; }
        .score-input-compact:focus { outline: none; background: white; border-radius: 6px; }
        .score-input-compact::placeholder { color: #D1D5DB; font-weight: 400; }
        .score-input-compact::-webkit-inner-spin-button, .score-input-compact::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .score-input-compact { -moz-appearance: textfield; }
        
        .match-row { display: flex; align-items: center; justify-content: center; gap: 6px; flex-wrap: nowrap; width: 100%; }
        
        .round-btn { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid rgba(0, 0, 0, 0.06); }
        .round-btn:active { transform: scale(0.95); }
        .round-btn.active { background: linear-gradient(135deg, #14B8A6 0%, #0D9488 100%); color: white; box-shadow: 0 2px 8px rgba(20, 184, 166, 0.3); }
        
        .resting-badge { background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); color: #92400E; padding: 6px 12px; border-radius: 100px; font-weight: 600; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 4px; border: 1px solid #F59E0B; }
        
        .standings-table { width: 100%; border-collapse: collapse; }
        .standings-table th { padding: 12px 16px; font-size: 0.75rem; font-weight: 600; color: #6B7280; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 2px solid #E5E7EB; text-align: left; }
        .standings-table th.text-center { text-align: center; }
        .standings-table td { padding: 12px 16px; border-bottom: 1px solid #F3F4F6; vertical-align: middle; }
        .standings-table tr:hover { background: #F9FAFB; }
        .standings-table tr.top-3 { background: linear-gradient(90deg, #F0FDFA 0%, white 100%); }
        .team-mini-badge { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.75rem; color: white; flex-shrink: 0; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        
        .player-color-0 { background: linear-gradient(135deg, #DC2626 0%, #991B1B 100%); }
        .player-color-1 { background: linear-gradient(135deg, #7C3AED 0%, #5B21B6 100%); }
        .player-color-2 { background: linear-gradient(135deg, #2563EB 0%, #1E40AF 100%); }
        .player-color-3 { background: linear-gradient(135deg, #059669 0%, #047857 100%); }
        .player-color-4 { background: linear-gradient(135deg, #EA580C 0%, #C2410C 100%); }
        .player-color-5 { background: linear-gradient(135deg, #0D9488 0%, #0F766E 100%); }
        .player-color-6 { background: linear-gradient(135deg, #DB2777 0%, #BE185D 100%); }
        .player-color-7 { background: linear-gradient(135deg, #4F46E5 0%, #3730A3 100%); }
        .player-color-8 { background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); }
        .player-color-9 { background: linear-gradient(135deg, #06B6D4 0%, #0891B2 100%); }
        .player-color-10 { background: linear-gradient(135deg, #F43F5E 0%, #E11D48 100%); }
        .player-color-11 { background: linear-gradient(135deg, #84CC16 0%, #65A30D 100%); }
        .player-color-12 { background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%); }
        .player-color-13 { background: linear-gradient(135deg, #10B981 0%, #059669 100%); }
        .player-color-14 { background: linear-gradient(135deg, #D946EF 0%, #C026D3 100%); }
        .player-color-15 { background: linear-gradient(135deg, #0EA5E9 0%, #0284C7 100%); }
        
        .team-color-0 { background: linear-gradient(135deg, #14B8A6 0%, #0D9488 100%); }
        .team-color-1 { background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%); }
        .team-color-2 { background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); }
        .team-color-3 { background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%); }
        .team-color-4 { background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); }
        .team-color-5 { background: linear-gradient(135deg, #EC4899 0%, #DB2777 100%); }
        .team-color-6 { background: linear-gradient(135deg, #10B981 0%, #059669 100%); }
        .team-color-7 { background: linear-gradient(135deg, #6366F1 0%, #4F46E5 100%); }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.05); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.2); border-radius: 10px; }
        
        .modal-backdrop { background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
        
        @media (max-width: 640px) {
            .match-card { border-radius: 12px; }
            .player-badge-compact { max-width: 115px; font-size: 0.75rem; padding: 6px 10px; }
            .score-box-horizontal { min-width: 130px; height: 60px; padding: 6px; }
            .score-input-compact { font-size: 1.5rem; width: 44px; }
            .team-stack { gap: 5px; }
            .match-row { gap: 5px; }
            .standings-table th, .standings-table td { padding: 10px 8px; font-size: 0.75rem; }
            .team-mini-badge { width: 32px; height: 32px; font-size: 0.625rem; }
        }
        @media (max-width: 380px) {
            .player-badge-compact { max-width: 95px; font-size: 0.6875rem; padding: 5px 8px; }
            .score-box-horizontal { min-width: 115px; height: 56px; }
            .score-input-compact { font-size: 1.35rem; width: 38px; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 via-white to-gray-50 min-h-screen">
    <div id="app"></div>
    <div id="modal-container"></div>
    <div id="toast-container" class="fixed bottom-4 right-4 z-50"></div>
    
    <script>
        const firebaseConfig = { apiKey: "AIzaSyDYIlRS_me7sy7ptNmRrvPQCeXP2H-hHzU", authDomain: "stretford-padel-tournament.firebaseapp.com", databaseURL: "https://stretford-padel-tournament-default-rtdb.europe-west1.firebasedatabase.app", projectId: "stretford-padel-tournament", storageBucket: "stretford-padel-tournament.firebasestorage.app", messagingSenderId: "596263602058", appId: "1:596263602058:web:f69f7f8d00c60abbd0aa73" };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        const state = { tournamentId: null, tournamentName: '', mode: 'individual', pointsPerMatch: 24, players: [], teams: [], rounds: [], currentRound: 0, viewingRound: 0, status: 'setup', activeTab: 'matches' };
        let scoresBeingEdited = new Set();
        let firebaseListener = null;
        
        const MyTournaments = {
            KEY: 'mexicano_tournaments',
            getAll() { try { return JSON.parse(localStorage.getItem(this.KEY)) || []; } catch { return []; } },
            save(t) { const all = this.getAll().filter(x => x.id !== t.id); all.unshift(t); localStorage.setItem(this.KEY, JSON.stringify(all.slice(0, 10))); }
        };
        
        function generateId() { return Math.random().toString(36).substring(2, 9); }
        function generateCode() { const chars = 'abcdefghjkmnpqrstuvwxyz23456789'; return Array.from({ length: 6 }, () => chars[Math.floor(Math.random() * chars.length)]).join(''); }
        function shuffleArray(arr) { const a = [...arr]; for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; }
        function formatTimeAgo(d) { if (!d) return ''; const diff = Date.now() - new Date(d).getTime(); const m = Math.floor(diff / 60000); if (m < 1) return 'Just now'; if (m < 60) return `${m}m ago`; const h = Math.floor(m / 60); if (h < 24) return `${h}h ago`; return `${Math.floor(h / 24)}d ago`; }
        function showToast(msg) { const c = document.getElementById('toast-container'); const t = document.createElement('div'); t.className = 'bg-gray-800 text-white px-4 py-3 rounded-xl shadow-lg mb-2 animate-slide-up'; t.textContent = msg; c.appendChild(t); setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity 0.3s'; setTimeout(() => t.remove(), 300); }, 3000); }
        function getPlayerColor(i) { return `player-color-${i % 16}`; }
        function getTeamColor(i) { return `team-color-${i % 8}`; }
        
        function handleRoute() { const m = window.location.hash.match(/\/t\/([a-zA-Z0-9]+)/); if (m) loadTournament(m[1].toLowerCase()); else renderLandingPage(); }
        
        function renderLandingPage() {
            if (firebaseListener) { database.ref().off('value', firebaseListener); firebaseListener = null; }
            const my = MyTournaments.getAll();
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen">
                    <div class="relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-br from-teal-600 via-teal-700 to-cyan-800"></div>
                        <div class="absolute inset-0 opacity-30"><div class="absolute top-20 left-10 w-64 h-64 bg-white rounded-full mix-blend-overlay filter blur-3xl opacity-20"></div><div class="absolute bottom-20 right-10 w-80 h-80 bg-cyan-300 rounded-full mix-blend-overlay filter blur-3xl opacity-20"></div></div>
                        <div class="relative max-w-5xl mx-auto px-6 py-16 md:py-24">
                            <div class="text-center">
                                <div class="inline-flex items-center gap-3 bg-white/10 backdrop-blur-sm rounded-full px-5 py-2 mb-8"><span class="text-3xl">üéØ</span><span class="text-white/90 font-medium">Mexicano Format</span></div>
                                <h1 class="text-4xl md:text-6xl font-bold text-white mb-6" style="letter-spacing: -2px; line-height: 1.1;">Dynamic<br>Matchups</h1>
                                <p class="text-lg md:text-xl text-white/80 max-w-2xl mx-auto mb-12" style="line-height: 1.6;">Pairings based on standings. 8+ players,<br class="hidden md:block">balanced competition, real-time leaderboard.</p>
                                <div class="flex flex-col sm:flex-row gap-4 justify-center max-w-md mx-auto">
                                    <button onclick="showCreateModal()" class="flex-1 px-8 py-4 bg-white text-teal-700 rounded-2xl font-semibold text-lg shadow-xl hover:shadow-2xl hover:scale-105 transition-all duration-200"><span class="mr-2">‚ú®</span> Create Session</button>
                                    <button onclick="showJoinModal()" class="flex-1 px-8 py-4 bg-white/10 backdrop-blur-sm text-white border-2 border-white/30 rounded-2xl font-semibold text-lg hover:bg-white/20 transition-all duration-200"><span class="mr-2">üîó</span> Join with Code</button>
                                </div>
                                <div class="mt-8"><a href="../" class="text-white/60 hover:text-white text-sm transition-colors">‚Üê Back to Stretford Padel Home</a></div>
                            </div>
                        </div>
                    </div>
                    ${my.length > 0 ? `<div class="max-w-5xl mx-auto px-6 py-12"><div class="flex items-center gap-3 mb-6"><div class="w-10 h-10 rounded-xl bg-teal-100 flex items-center justify-center"><span class="text-xl">üìã</span></div><h2 class="text-2xl font-bold text-gray-800">My Sessions</h2></div><div class="grid gap-4">${my.map(t => `<div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 hover:shadow-md transition-shadow"><div class="flex items-center justify-between"><div class="flex items-center gap-4 flex-1 min-w-0"><div class="w-12 h-12 rounded-xl bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center text-white font-bold text-lg flex-shrink-0">${t.name ? t.name.charAt(0).toUpperCase() : 'üéØ'}</div><div class="min-w-0"><h3 class="font-semibold text-gray-800 truncate">${t.name || 'Unnamed'}</h3><div class="flex items-center gap-2 text-sm text-gray-500"><span class="font-mono font-medium text-teal-600">${t.id.toUpperCase()}</span><span class="text-gray-300">‚Ä¢</span><span>${formatTimeAgo(t.createdAt)}</span></div></div></div><button onclick="window.location.hash='/t/${t.id}'" class="px-4 py-2 bg-teal-500 hover:bg-teal-600 text-white rounded-xl font-medium text-sm transition-colors">Open</button></div></div>`).join('')}</div></div>` : ''}
                    <div class="max-w-5xl mx-auto px-6 py-12"><h2 class="text-2xl font-bold text-gray-800 text-center mb-8">How Mexicano Works</h2><div class="grid md:grid-cols-3 gap-6"><div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 text-center"><div class="w-16 h-16 mx-auto mb-4 bg-teal-100 rounded-2xl flex items-center justify-center"><span class="text-3xl">üé≤</span></div><h3 class="font-semibold text-gray-800 mb-2">Round 1: Lottery</h3><p class="text-sm text-gray-500">First round pairings are random. After that, standings decide.</p></div><div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 text-center"><div class="w-16 h-16 mx-auto mb-4 bg-cyan-100 rounded-2xl flex items-center justify-center"><span class="text-3xl">üìä</span></div><h3 class="font-semibold text-gray-800 mb-2">Dynamic Pairings</h3><p class="text-sm text-gray-500">#1 & #3 vs #2 & #4. Better players face tougher opponents.</p></div><div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 text-center"><div class="w-16 h-16 mx-auto mb-4 bg-green-100 rounded-2xl flex items-center justify-center"><span class="text-3xl">üèÜ</span></div><h3 class="font-semibold text-gray-800 mb-2">Individual Points</h3><p class="text-sm text-gray-500">Both players get their team's score. Most points wins!</p></div></div></div>
                    <div class="max-w-5xl mx-auto px-6 py-8 text-center text-sm text-gray-400"><p>Stretford Padel Club ‚Ä¢ Mexicano Tournament Manager</p></div>
                </div>`;
        }
        
        function showCreateModal() {
            state.mode = 'individual'; state.pointsPerMatch = 24;
            document.getElementById('modal-container').innerHTML = `<div class="fixed inset-0 z-50 flex items-center justify-center p-4" onclick="closeModal(event)"><div class="modal-backdrop absolute inset-0"></div><div class="relative bg-white rounded-3xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto animate-scale-in" onclick="event.stopPropagation()"><div class="bg-gradient-to-r from-teal-600 to-teal-500 px-6 py-5 rounded-t-3xl"><h2 class="text-xl font-bold text-white">üéØ Create Mexicano Session</h2></div><div class="p-6"><div class="mb-5"><label class="block text-sm font-semibold text-gray-700 mb-2">Session Name</label><input type="text" id="create-name" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:outline-none" placeholder="Friday Night Mexicano" maxlength="40" /></div><div class="mb-5"><label class="block text-sm font-semibold text-gray-700 mb-3">Mode</label><div class="grid grid-cols-2 gap-3"><button type="button" onclick="selectCreateMode('individual')" id="mode-individual" class="p-4 rounded-xl border-2 border-teal-500 bg-teal-50 text-left transition-all"><div class="text-xl mb-1">üîÑ</div><div class="font-semibold text-gray-800">Individual</div><div class="text-xs text-gray-500">Rotating partners</div></button><button type="button" onclick="selectCreateMode('team')" id="mode-team" class="p-4 rounded-xl border-2 border-gray-200 text-left transition-all hover:border-gray-300"><div class="text-xl mb-1">üëØ</div><div class="font-semibold text-gray-800">Team</div><div class="text-xs text-gray-500">Fixed partners</div></button></div></div><div class="mb-6"><label class="block text-sm font-semibold text-gray-700 mb-3">Points Per Match</label><div class="grid grid-cols-3 gap-3"><button type="button" onclick="selectCreatePoints(16)" id="points-16" class="p-3 rounded-xl border-2 border-gray-200 text-center transition-all hover:border-gray-300"><div class="text-xl font-bold text-gray-800">16</div><div class="text-xs text-gray-500">~8 min</div></button><button type="button" onclick="selectCreatePoints(24)" id="points-24" class="p-3 rounded-xl border-2 border-teal-500 bg-teal-50 text-center transition-all"><div class="text-xl font-bold text-gray-800">24</div><div class="text-xs text-gray-500">~12 min</div></button><button type="button" onclick="selectCreatePoints(32)" id="points-32" class="p-3 rounded-xl border-2 border-gray-200 text-center transition-all hover:border-gray-300"><div class="text-xl font-bold text-gray-800">32</div><div class="text-xs text-gray-500">~16 min</div></button></div></div><div class="flex gap-3"><button onclick="closeModal()" class="flex-1 py-3 rounded-xl border-2 border-gray-200 text-gray-700 font-semibold hover:bg-gray-50 transition-colors">Cancel</button><button onclick="goToAddPlayers()" class="flex-1 py-3 rounded-xl bg-teal-500 hover:bg-teal-600 text-white font-semibold transition-colors">Continue</button></div></div></div></div>`;
        }
        
        function selectCreateMode(mode) { state.mode = mode; document.getElementById('mode-individual').className = `p-4 rounded-xl border-2 ${mode === 'individual' ? 'border-teal-500 bg-teal-50' : 'border-gray-200 hover:border-gray-300'} text-left transition-all`; document.getElementById('mode-team').className = `p-4 rounded-xl border-2 ${mode === 'team' ? 'border-teal-500 bg-teal-50' : 'border-gray-200 hover:border-gray-300'} text-left transition-all`; }
        function selectCreatePoints(pts) { state.pointsPerMatch = pts; [16, 24, 32].forEach(p => { document.getElementById(`points-${p}`).className = `p-3 rounded-xl border-2 ${p === pts ? 'border-teal-500 bg-teal-50' : 'border-gray-200 hover:border-gray-300'} text-center transition-all`; }); }
        function goToAddPlayers() { const name = document.getElementById('create-name').value.trim(); if (!name) { showToast('‚ö†Ô∏è Please enter a session name'); return; } state.tournamentName = name; state.players = []; state.teams = []; showAddPlayersModal(); }
        
        function showAddPlayersModal() {
            const isTeam = state.mode === 'team'; const min = isTeam ? 4 : 8; const items = isTeam ? state.teams : state.players;
            document.getElementById('modal-container').innerHTML = `<div class="fixed inset-0 z-50 flex items-center justify-center p-4" onclick="closeModal(event)"><div class="modal-backdrop absolute inset-0"></div><div class="relative bg-white rounded-3xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto animate-scale-in" onclick="event.stopPropagation()"><div class="bg-gradient-to-r from-teal-600 to-teal-500 px-6 py-5 rounded-t-3xl"><h2 class="text-xl font-bold text-white">${isTeam ? 'üëØ Add Teams' : 'üë• Add Players'}</h2></div><div class="p-6"><p class="text-gray-500 text-sm mb-4">Minimum ${min} ${isTeam ? 'teams' : 'players'} required</p>${isTeam ? `<div class="flex gap-2 mb-4"><input type="text" id="player1-input" class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:outline-none" placeholder="Player 1" maxlength="20" /><input type="text" id="player2-input" class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:outline-none" placeholder="Player 2" maxlength="20" onkeypress="if(event.key==='Enter')addTeamFromModal()" /></div><button onclick="addTeamFromModal()" class="w-full py-3 bg-gray-100 hover:bg-gray-200 rounded-xl font-semibold text-gray-700 transition-colors mb-4">+ Add Team</button>` : `<div class="flex gap-2 mb-4"><input type="text" id="player-input" class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:outline-none" placeholder="Player name" maxlength="20" onkeypress="if(event.key==='Enter')addPlayerFromModal()" /><button onclick="addPlayerFromModal()" class="px-5 py-3 bg-teal-500 hover:bg-teal-600 text-white rounded-xl font-semibold transition-colors">Add</button></div>`}<div id="players-list" class="space-y-2 mb-6 max-h-48 overflow-y-auto">${renderPlayersList()}</div><div class="flex gap-3"><button onclick="showCreateModal()" class="flex-1 py-3 rounded-xl border-2 border-gray-200 text-gray-700 font-semibold hover:bg-gray-50 transition-colors">Back</button><button onclick="createTournament()" id="btn-create" class="flex-1 py-3 rounded-xl bg-teal-500 hover:bg-teal-600 text-white font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed" ${items.length < min ? 'disabled' : ''}>Start (${items.length}/${min}+)</button></div></div></div></div>`;
            setTimeout(() => { const input = document.getElementById(isTeam ? 'player1-input' : 'player-input'); if (input) input.focus(); }, 100);
        }
        
        function renderPlayersList() { const isTeam = state.mode === 'team'; const items = isTeam ? state.teams : state.players; if (items.length === 0) return `<div class="text-center py-6 text-gray-400">No ${isTeam ? 'teams' : 'players'} added yet</div>`; return items.map((item, i) => `<div class="flex items-center gap-3 bg-gray-50 rounded-xl px-4 py-3"><div class="w-8 h-8 rounded-lg ${isTeam ? getTeamColor(i) : getPlayerColor(i)} flex items-center justify-center text-white font-bold text-sm">${i + 1}</div><span class="flex-1 font-medium text-gray-800">${isTeam ? `${item.player1} & ${item.player2}` : item.name}</span><button onclick="removeItem(${i})" class="text-gray-400 hover:text-red-500 transition-colors">‚úï</button></div>`).join(''); }
        
        function addPlayerFromModal() { const input = document.getElementById('player-input'); const name = input.value.trim(); if (!name) { showToast('‚ö†Ô∏è Enter a player name'); return; } if (state.players.some(p => p.name.toLowerCase() === name.toLowerCase())) { showToast('‚ö†Ô∏è Player already added'); return; } state.players.push({ id: generateId(), name, totalPoints: 0, matchesPlayed: 0 }); input.value = ''; input.focus(); refreshPlayersList(); }
        function addTeamFromModal() { const i1 = document.getElementById('player1-input'); const i2 = document.getElementById('player2-input'); const p1 = i1.value.trim(), p2 = i2.value.trim(); if (!p1 || !p2) { showToast('‚ö†Ô∏è Enter both player names'); return; } state.teams.push({ id: generateId(), player1: p1, player2: p2, teamName: `${p1} & ${p2}`, totalPoints: 0, matchesPlayed: 0 }); i1.value = ''; i2.value = ''; i1.focus(); refreshPlayersList(); }
        function removeItem(i) { if (state.mode === 'team') state.teams.splice(i, 1); else state.players.splice(i, 1); refreshPlayersList(); }
        function refreshPlayersList() { const isTeam = state.mode === 'team'; const items = isTeam ? state.teams : state.players; const min = isTeam ? 4 : 8; document.getElementById('players-list').innerHTML = renderPlayersList(); const btn = document.getElementById('btn-create'); btn.disabled = items.length < min; btn.textContent = `Start (${items.length}/${min}+)`; }
        
        function showJoinModal() { document.getElementById('modal-container').innerHTML = `<div class="fixed inset-0 z-50 flex items-center justify-center p-4" onclick="closeModal(event)"><div class="modal-backdrop absolute inset-0"></div><div class="relative bg-white rounded-3xl shadow-2xl max-w-md w-full animate-scale-in" onclick="event.stopPropagation()"><div class="bg-gradient-to-r from-teal-600 to-teal-500 px-6 py-5 rounded-t-3xl"><h2 class="text-xl font-bold text-white">üîó Join Session</h2></div><div class="p-6"><div class="mb-6"><label class="block text-sm font-semibold text-gray-700 mb-2">Session Code</label><input type="text" id="join-code" class="w-full px-4 py-4 border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:outline-none text-center text-2xl font-mono tracking-widest uppercase" placeholder="ABC123" maxlength="10" onkeypress="if(event.key==='Enter')joinSession()" /></div><div class="flex gap-3"><button onclick="closeModal()" class="flex-1 py-3 rounded-xl border-2 border-gray-200 text-gray-700 font-semibold hover:bg-gray-50 transition-colors">Cancel</button><button onclick="joinSession()" class="flex-1 py-3 rounded-xl bg-teal-500 hover:bg-teal-600 text-white font-semibold transition-colors">Join</button></div></div></div></div>`; setTimeout(() => document.getElementById('join-code').focus(), 100); }
        async function joinSession() { const code = document.getElementById('join-code').value.trim().toLowerCase(); if (!code) { showToast('‚ö†Ô∏è Enter a session code'); return; } try { const snap = await database.ref(`mexicano/${code}/meta`).once('value'); if (snap.exists()) { window.location.hash = `/t/${code}`; closeModal(); } else { showToast('‚ùå Session not found'); } } catch (e) { showToast('‚ùå Error joining session'); } }
        function closeModal(e) { if (e && e.target !== e.currentTarget) return; document.getElementById('modal-container').innerHTML = ''; }
        
        async function createTournament() { const id = generateCode(); state.tournamentId = id; state.rounds = [generateRound(1)]; state.currentRound = 1; state.viewingRound = 1; state.status = 'active'; const data = { meta: { name: state.tournamentName, mode: state.mode, pointsPerMatch: state.pointsPerMatch, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString(), status: 'active' }, currentRound: 1, playerCount: state.mode === 'individual' ? state.players.length : state.teams.length * 2, rounds: state.rounds }; if (state.mode === 'individual') data.players = state.players; else data.teams = state.teams; try { await database.ref(`mexicano/${id}`).set(data); MyTournaments.save({ id, name: state.tournamentName, createdAt: data.meta.createdAt }); closeModal(); window.location.hash = `/t/${id}`; showToast('‚úÖ Session created!'); } catch (e) { showToast('‚ùå Error creating session'); } }
        
        async function loadTournament(id) { try { const snap = await database.ref(`mexicano/${id}`).once('value'); if (!snap.exists()) { showToast('‚ùå Session not found'); window.location.hash = ''; return; } const d = snap.val(); state.tournamentId = id; state.tournamentName = d.meta.name; state.mode = d.meta.mode; state.pointsPerMatch = d.meta.pointsPerMatch; state.players = d.players || []; state.teams = d.teams || []; state.rounds = d.rounds || []; state.currentRound = d.currentRound || 1; state.viewingRound = state.currentRound; state.status = d.meta.status; MyTournaments.save({ id, name: state.tournamentName, createdAt: d.meta.createdAt }); if (state.status === 'completed') renderCompletedScreen(); else { renderTournament(); setupRealtimeListener(id); } } catch (e) { showToast('‚ùå Error loading session'); window.location.hash = ''; } }
        
        function generateRound(n) { return state.mode === 'individual' ? generateIndividualRound(n) : generateTeamRound(n); }
        function generateIndividualRound(n) { let sorted = n === 1 ? shuffleArray([...state.players]) : [...state.players].sort((a, b) => b.totalPoints - a.totalPoints || a.matchesPlayed - b.matchesPlayed); const matches = []; const courts = Math.floor(sorted.length / 4); for (let c = 0; c < courts; c++) { const base = c * 4; const t1 = [sorted[base], sorted[base + 2]]; const t2 = [sorted[base + 1], sorted[base + 3]]; matches.push({ id: generateId(), court: c + 1, team1: t1.map(p => p.id), team1Names: t1.map(p => p.name), team1Indices: t1.map(p => state.players.findIndex(x => x.id === p.id)), team2: t2.map(p => p.id), team2Names: t2.map(p => p.name), team2Indices: t2.map(p => state.players.findIndex(x => x.id === p.id)), score1: null, score2: null, completed: false }); } return { roundNumber: n, matches, sittingOut: sorted.slice(courts * 4).map(p => ({ id: p.id, name: p.name, index: state.players.findIndex(x => x.id === p.id) })), completed: false }; }
        function generateTeamRound(n) { let sorted = n === 1 ? shuffleArray([...state.teams]) : [...state.teams].sort((a, b) => b.totalPoints - a.totalPoints || a.matchesPlayed - b.matchesPlayed); const matches = []; const numMatches = Math.floor(sorted.length / 2); for (let i = 0; i < numMatches; i++) { const t1 = sorted[i * 2], t2 = sorted[i * 2 + 1]; matches.push({ id: generateId(), court: i + 1, team1: t1.id, team1Name: t1.teamName, team1Players: [t1.player1, t1.player2], team1Index: state.teams.findIndex(x => x.id === t1.id), team2: t2.id, team2Name: t2.teamName, team2Players: [t2.player1, t2.player2], team2Index: state.teams.findIndex(x => x.id === t2.id), score1: null, score2: null, completed: false }); } const sittingOut = sorted.length % 2 !== 0 ? [{ id: sorted[sorted.length - 1].id, name: sorted[sorted.length - 1].teamName, index: state.teams.findIndex(x => x.id === sorted[sorted.length - 1].id) }] : []; return { roundNumber: n, matches, sittingOut, completed: false }; }
        
        function renderTournament() {
            document.getElementById('app').innerHTML = `<div class="min-h-screen"><div class="bg-gradient-to-r from-teal-600 to-teal-500 text-white sticky top-0 z-30 shadow-lg"><div class="max-w-3xl mx-auto px-4 py-4"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><a href="#" class="text-2xl hover:scale-110 transition-transform">üéØ</a><div><h1 class="font-bold text-lg leading-tight">${state.tournamentName}</h1><div class="flex items-center gap-2 text-sm text-teal-100"><span>${state.mode === 'individual' ? 'Individual' : 'Team'}</span><span>‚Ä¢</span><span>${state.pointsPerMatch} pts</span></div></div></div><div class="bg-white/20 backdrop-blur-sm rounded-lg px-3 py-1.5 flex items-center gap-2"><span class="font-mono font-bold tracking-wider">${state.tournamentId.toUpperCase()}</span><button onclick="copyCode()" class="text-teal-100 hover:text-white transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg></button></div></div></div></div><div class="max-w-3xl mx-auto px-4 py-4"><div class="bg-gray-100 rounded-2xl p-1.5 flex gap-1"><button onclick="switchTab('matches')" class="flex-1 py-3 px-4 rounded-xl text-sm font-semibold transition-all ${state.activeTab === 'matches' ? 'tab-active' : 'tab-inactive'}">üéæ Matches</button><button onclick="switchTab('standings')" class="flex-1 py-3 px-4 rounded-xl text-sm font-semibold transition-all ${state.activeTab === 'standings' ? 'tab-active' : 'tab-inactive'}">üèÜ Standings</button><button onclick="switchTab('settings')" class="flex-1 py-3 px-4 rounded-xl text-sm font-semibold transition-all ${state.activeTab === 'settings' ? 'tab-active' : 'tab-inactive'}">‚öôÔ∏è Settings</button></div></div><div class="max-w-3xl mx-auto px-4 pb-8">${state.activeTab === 'matches' ? renderMatchesTab() : ''}${state.activeTab === 'standings' ? renderStandingsTab() : ''}${state.activeTab === 'settings' ? renderSettingsTab() : ''}</div></div>`;
        }
        function switchTab(t) { state.activeTab = t; renderTournament(); }
        
        function renderMatchesTab() { const round = state.rounds[state.viewingRound - 1]; if (!round) return '<p class="text-center text-gray-500 py-8">No matches</p>'; const isCurrent = state.viewingRound === state.currentRound; return `<div class="flex gap-2 mb-4 overflow-x-auto pb-2">${state.rounds.map((r, i) => `<button onclick="viewRound(${i + 1})" class="round-btn px-4 py-2 rounded-xl text-sm font-semibold whitespace-nowrap ${state.viewingRound === i + 1 ? 'active' : 'bg-white text-gray-600 hover:bg-gray-50'}">Round ${i + 1}</button>`).join('')}</div><div class="space-y-4">${round.matches.map((m, i) => renderMatchCard(m, i, isCurrent)).join('')}</div>${round.sittingOut?.length ? `<div class="mt-4 bg-amber-50 border border-amber-200 rounded-2xl p-4"><div class="flex items-center gap-3 flex-wrap"><span class="resting-badge">‚è≥ Sitting Out</span>${round.sittingOut.map(p => `<span class="player-badge-compact ${state.mode === 'individual' ? getPlayerColor(p.index) : getTeamColor(p.index)}" style="opacity: 0.7; max-width: none; width: auto;">${p.name}</span>`).join('')}</div></div>` : ''}${isCurrent && round.matches.every(m => m.completed) && !round.completed ? `<div class="mt-6"><button onclick="completeRound()" class="w-full py-4 bg-gradient-to-r from-teal-500 to-teal-600 hover:from-teal-600 hover:to-teal-700 text-white rounded-2xl font-semibold text-lg shadow-lg hover:shadow-xl transition-all">Complete Round & Generate Next ‚Üí</button></div>` : ''}`; }
        
        function renderMatchCard(m, i, isCurrent) { const done = m.completed; const colorFn = state.mode === 'individual' ? getPlayerColor : getTeamColor; const t1Names = state.mode === 'individual' ? m.team1Names : m.team1Players; const t2Names = state.mode === 'individual' ? m.team2Names : m.team2Players; const t1Idx = state.mode === 'individual' ? m.team1Indices : [m.team1Index, m.team1Index]; const t2Idx = state.mode === 'individual' ? m.team2Indices : [m.team2Index, m.team2Index]; return `<div class="match-card ${done ? 'complete' : ''} p-4 animate-slide-up" style="animation-delay: ${i * 0.05}s"><div class="flex items-center justify-between mb-3"><div class="flex items-center gap-2"><span class="bg-teal-100 text-teal-700 text-xs font-bold px-2 py-1 rounded-lg">Court ${m.court}</span>${done ? '<span class="text-green-600 text-xs font-semibold">‚úì Complete</span>' : ''}</div>${done ? `<button onclick="editMatch('${m.id}')" class="text-gray-400 hover:text-teal-600 transition-colors text-sm">Edit</button>` : ''}</div><div class="match-row"><div class="team-stack ${done && m.score1 > m.score2 ? 'winner' : ''}"><span class="player-badge-compact ${colorFn(t1Idx[0])}">${t1Names[0]}</span><span class="player-badge-compact ${colorFn(t1Idx[1])}">${t1Names[1]}</span></div><div class="score-box-horizontal ${done ? 'score-complete' : ''}"><div class="flex items-center gap-2">${isCurrent && !done ? `<input type="number" class="score-input-compact" value="${m.score1 !== null ? m.score1 : ''}" data-match="${m.id}" data-team="1" onfocus="onScoreFocus('${m.id}')" onblur="onScoreBlur('${m.id}', 1, this.value)" oninput="onScoreInput('${m.id}', 1, this.value)" min="0" max="${state.pointsPerMatch}" placeholder="-" /><span class="text-gray-400 font-bold text-xl">:</span><input type="number" class="score-input-compact" value="${m.score2 !== null ? m.score2 : ''}" data-match="${m.id}" data-team="2" onfocus="onScoreFocus('${m.id}')" onblur="onScoreBlur('${m.id}', 2, this.value)" oninput="onScoreInput('${m.id}', 2, this.value)" min="0" max="${state.pointsPerMatch}" placeholder="-" />` : `<span class="score-input-compact">${m.score1 !== null ? m.score1 : '-'}</span><span class="text-gray-400 font-bold text-xl">:</span><span class="score-input-compact">${m.score2 !== null ? m.score2 : '-'}</span>`}</div></div><div class="team-stack ${done && m.score2 > m.score1 ? 'winner' : ''}"><span class="player-badge-compact ${colorFn(t2Idx[0])}">${t2Names[0]}</span><span class="player-badge-compact ${colorFn(t2Idx[1])}">${t2Names[1]}</span></div></div></div>`; }
        
        function renderStandingsTab() { const items = state.mode === 'individual' ? [...state.players].sort((a, b) => b.totalPoints - a.totalPoints) : [...state.teams].sort((a, b) => b.totalPoints - a.totalPoints); return `<div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden"><table class="standings-table"><thead><tr><th class="text-center">#</th><th>${state.mode === 'individual' ? 'Player' : 'Team'}</th><th class="text-center">Played</th><th class="text-center">Points</th></tr></thead><tbody>${items.map((item, i) => { const origIdx = state.mode === 'individual' ? state.players.findIndex(p => p.id === item.id) : state.teams.findIndex(t => t.id === item.id); const colorClass = state.mode === 'individual' ? getPlayerColor(origIdx) : getTeamColor(origIdx); return `<tr class="${i < 3 ? 'top-3' : ''}"><td class="text-center font-bold ${i < 3 ? 'text-teal-600' : 'text-gray-400'}">${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : i + 1}</td><td><div class="flex items-center gap-3"><div class="team-mini-badge ${colorClass}">${state.mode === 'individual' ? item.name.charAt(0).toUpperCase() : origIdx + 1}</div><span class="font-semibold text-gray-800">${state.mode === 'individual' ? item.name : `${item.player1} & ${item.player2}`}</span></div></td><td class="text-center text-gray-500">${item.matchesPlayed}</td><td class="text-center font-bold ${i < 3 ? 'text-teal-600' : 'text-gray-800'} text-lg">${item.totalPoints}</td></tr>`; }).join('')}</tbody></table></div>`; }
        
        function renderSettingsTab() { return `<div class="space-y-4"><div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5"><h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">üîó Share Session</h3><div class="bg-gray-50 rounded-xl p-4 mb-4 text-center"><div class="text-xs text-gray-500 mb-1">Session Code</div><div class="text-3xl font-mono font-bold text-teal-600 tracking-widest">${state.tournamentId.toUpperCase()}</div></div><div class="grid grid-cols-2 gap-3"><button onclick="copyCode()" class="flex items-center justify-center gap-2 py-3 bg-gray-100 hover:bg-gray-200 rounded-xl font-medium transition-colors">üìã Copy Code</button><button onclick="shareLink()" class="flex items-center justify-center gap-2 py-3 bg-teal-100 hover:bg-teal-200 text-teal-700 rounded-xl font-medium transition-colors">üîó Share Link</button></div></div><div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5"><h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">üìä Session Info</h3><div class="space-y-3 text-sm"><div class="flex justify-between py-2 border-b border-gray-100"><span class="text-gray-500">Mode</span><span class="font-medium">${state.mode === 'individual' ? 'Individual' : 'Team'}</span></div><div class="flex justify-between py-2 border-b border-gray-100"><span class="text-gray-500">Points per Match</span><span class="font-medium">${state.pointsPerMatch}</span></div><div class="flex justify-between py-2 border-b border-gray-100"><span class="text-gray-500">${state.mode === 'individual' ? 'Players' : 'Teams'}</span><span class="font-medium">${state.mode === 'individual' ? state.players.length : state.teams.length}</span></div><div class="flex justify-between py-2"><span class="text-gray-500">Current Round</span><span class="font-medium">${state.currentRound}</span></div></div></div><div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5"><h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">üèÅ End Tournament</h3><p class="text-sm text-gray-500 mb-4">Declare the winner based on current standings.</p><button onclick="confirmEnd()" class="w-full py-3 bg-red-50 hover:bg-red-100 text-red-600 rounded-xl font-semibold transition-colors">End Tournament</button></div></div>`; }
        
        function onScoreFocus(id) { scoresBeingEdited.add(id); }
        function onScoreInput(id, team, val) { const round = state.rounds[state.currentRound - 1]; const m = round?.matches.find(x => x.id === id); if (!m || m.completed) return; let score = val === '' ? null : parseInt(val); if (score !== null && score > state.pointsPerMatch) score = state.pointsPerMatch; if (score !== null && score < 0) score = 0; if (team === 1) m.score1 = score; else m.score2 = score; if (score !== null) { const other = state.pointsPerMatch - score; const otherInput = document.querySelector(`input[data-match="${id}"][data-team="${team === 1 ? 2 : 1}"]`); if (otherInput) otherInput.value = other; if (team === 1) m.score2 = other; else m.score1 = other; } }
        async function onScoreBlur(id, team, val) { scoresBeingEdited.delete(id); const round = state.rounds[state.currentRound - 1]; const m = round?.matches.find(x => x.id === id); if (!m || m.completed) return; let score = val === '' ? null : parseInt(val); if (score !== null && score > state.pointsPerMatch) score = state.pointsPerMatch; if (score !== null && score < 0) score = 0; if (team === 1) m.score1 = score; else m.score2 = score; if (score !== null) { const other = state.pointsPerMatch - score; if (team === 1) m.score2 = other; else m.score1 = other; } if (m.score1 !== null && m.score2 !== null && m.score1 + m.score2 === state.pointsPerMatch) { m.completed = true; updatePoints(m, m.score1, m.score2); showToast('‚úÖ Match saved!'); } await saveToFirebase(); renderTournament(); }
        
        function updatePoints(m, s1, s2) { if (state.mode === 'individual') { m.team1.forEach(id => { const p = state.players.find(x => x.id === id); if (p) { p.totalPoints += s1; p.matchesPlayed++; } }); m.team2.forEach(id => { const p = state.players.find(x => x.id === id); if (p) { p.totalPoints += s2; p.matchesPlayed++; } }); } else { const t1 = state.teams.find(t => t.id === m.team1); const t2 = state.teams.find(t => t.id === m.team2); if (t1) { t1.totalPoints += s1; t1.matchesPlayed++; } if (t2) { t2.totalPoints += s2; t2.matchesPlayed++; } } }
        function revertPoints(m) { if (state.mode === 'individual') { m.team1.forEach(id => { const p = state.players.find(x => x.id === id); if (p) { p.totalPoints -= m.score1; p.matchesPlayed--; } }); m.team2.forEach(id => { const p = state.players.find(x => x.id === id); if (p) { p.totalPoints -= m.score2; p.matchesPlayed--; } }); } else { const t1 = state.teams.find(t => t.id === m.team1); const t2 = state.teams.find(t => t.id === m.team2); if (t1) { t1.totalPoints -= m.score1; t1.matchesPlayed--; } if (t2) { t2.totalPoints -= m.score2; t2.matchesPlayed--; } } }
        
        function viewRound(n) { state.viewingRound = n; renderTournament(); }
        async function completeRound() { state.rounds[state.currentRound - 1].completed = true; state.rounds.push(generateRound(state.currentRound + 1)); state.currentRound++; state.viewingRound = state.currentRound; await saveToFirebase(); showToast(`üéØ Round ${state.currentRound} generated!`); renderTournament(); }
        
        function editMatch(id) { const round = state.rounds.find(r => r.matches.some(m => m.id === id)); const m = round?.matches.find(x => x.id === id); if (!m) return; const t1Label = state.mode === 'individual' ? m.team1Names.join(' & ') : m.team1Players.join(' & '); const t2Label = state.mode === 'individual' ? m.team2Names.join(' & ') : m.team2Players.join(' & '); document.getElementById('modal-container').innerHTML = `<div class="fixed inset-0 z-50 flex items-center justify-center p-4" onclick="closeModal(event)"><div class="modal-backdrop absolute inset-0"></div><div class="relative bg-white rounded-3xl shadow-2xl max-w-md w-full animate-scale-in" onclick="event.stopPropagation()"><div class="bg-gradient-to-r from-teal-600 to-teal-500 px-6 py-5 rounded-t-3xl"><h2 class="text-xl font-bold text-white">Edit Match Score</h2></div><div class="p-6"><p class="text-gray-500 text-sm mb-4 text-center">Round ${round.roundNumber}, Court ${m.court}</p><div class="flex items-center justify-center gap-4 mb-6"><div class="text-center"><div class="text-sm font-medium text-gray-700 mb-2">${t1Label}</div><input type="number" id="edit-score1" class="w-20 h-14 text-center text-2xl font-bold border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:outline-none" value="${m.score1}" min="0" max="${state.pointsPerMatch}" oninput="onEditInput(1, this.value)" /></div><span class="text-2xl text-gray-400 font-bold">:</span><div class="text-center"><div class="text-sm font-medium text-gray-700 mb-2">${t2Label}</div><input type="number" id="edit-score2" class="w-20 h-14 text-center text-2xl font-bold border-2 border-gray-200 rounded-xl focus:border-teal-500 focus:outline-none" value="${m.score2}" min="0" max="${state.pointsPerMatch}" oninput="onEditInput(2, this.value)" /></div></div><div class="flex gap-3"><button onclick="closeModal()" class="flex-1 py-3 rounded-xl border-2 border-gray-200 text-gray-700 font-semibold hover:bg-gray-50">Cancel</button><button onclick="saveEdit('${id}', ${round.roundNumber - 1})" class="flex-1 py-3 rounded-xl bg-teal-500 hover:bg-teal-600 text-white font-semibold">Save</button></div></div></div></div>`; }
        function onEditInput(team, val) { let score = val === '' ? 0 : parseInt(val); if (score > state.pointsPerMatch) score = state.pointsPerMatch; if (score < 0) score = 0; document.getElementById(`edit-score${team === 1 ? 2 : 1}`).value = state.pointsPerMatch - score; }
        async function saveEdit(id, roundIdx) { const m = state.rounds[roundIdx].matches.find(x => x.id === id); if (!m) return; const s1 = parseInt(document.getElementById('edit-score1').value); const s2 = parseInt(document.getElementById('edit-score2').value); if (s1 + s2 !== state.pointsPerMatch) { showToast(`‚ö†Ô∏è Scores must total ${state.pointsPerMatch}`); return; } revertPoints(m); m.score1 = s1; m.score2 = s2; updatePoints(m, s1, s2); await saveToFirebase(); closeModal(); showToast('‚úÖ Score updated!'); renderTournament(); }
        
        function confirmEnd() { document.getElementById('modal-container').innerHTML = `<div class="fixed inset-0 z-50 flex items-center justify-center p-4" onclick="closeModal(event)"><div class="modal-backdrop absolute inset-0"></div><div class="relative bg-white rounded-3xl shadow-2xl max-w-md w-full animate-scale-in" onclick="event.stopPropagation()"><div class="bg-gradient-to-r from-red-600 to-red-500 px-6 py-5 rounded-t-3xl"><h2 class="text-xl font-bold text-white">End Tournament?</h2></div><div class="p-6"><p class="text-gray-600 mb-6">Winner will be declared based on current standings.</p><div class="flex gap-3"><button onclick="closeModal()" class="flex-1 py-3 rounded-xl border-2 border-gray-200 text-gray-700 font-semibold hover:bg-gray-50">Cancel</button><button onclick="endTournament()" class="flex-1 py-3 rounded-xl bg-red-500 hover:bg-red-600 text-white font-semibold">End</button></div></div></div></div>`; }
        async function endTournament() { state.status = 'completed'; await database.ref(`mexicano/${state.tournamentId}/meta/status`).set('completed'); closeModal(); renderCompletedScreen(); showToast('üèÜ Tournament complete!'); }
        
        function renderCompletedScreen() { const items = state.mode === 'individual' ? [...state.players].sort((a, b) => b.totalPoints - a.totalPoints) : [...state.teams].sort((a, b) => b.totalPoints - a.totalPoints); const winner = items[0]; document.getElementById('app').innerHTML = `<div class="min-h-screen bg-gradient-to-br from-teal-50 to-cyan-50"><div class="max-w-2xl mx-auto px-4 py-12"><div class="text-center mb-8"><div class="text-6xl mb-4">üèÜ</div><h1 class="text-3xl font-bold text-gray-800 mb-2">Tournament Complete!</h1><p class="text-xl text-teal-600 font-semibold">${state.mode === 'individual' ? winner.name : `${winner.player1} & ${winner.player2}`} wins with ${winner.totalPoints} points!</p></div><div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-6"><table class="standings-table"><thead><tr><th class="text-center">#</th><th>${state.mode === 'individual' ? 'Player' : 'Team'}</th><th class="text-center">Points</th></tr></thead><tbody>${items.map((item, i) => `<tr class="${i === 0 ? 'bg-yellow-50' : i < 3 ? 'bg-teal-50/50' : ''}"><td class="text-center font-bold">${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : i + 1}</td><td class="font-semibold">${state.mode === 'individual' ? item.name : `${item.player1} & ${item.player2}`}</td><td class="text-center font-bold text-lg">${item.totalPoints}</td></tr>`).join('')}</tbody></table></div><button onclick="window.location.hash=''" class="w-full py-4 bg-gradient-to-r from-teal-500 to-teal-600 text-white rounded-2xl font-semibold text-lg">Back to Home</button></div></div>`; }
        
        async function saveToFirebase() { if (!state.tournamentId) return; try { const updates = { 'meta/updatedAt': new Date().toISOString(), currentRound: state.currentRound, rounds: state.rounds }; if (state.mode === 'individual') updates.players = state.players; else updates.teams = state.teams; await database.ref(`mexicano/${state.tournamentId}`).update(updates); } catch (e) { showToast('‚ùå Error saving'); } }
        function setupRealtimeListener(id) { if (firebaseListener) database.ref().off('value', firebaseListener); firebaseListener = database.ref(`mexicano/${id}`).on('value', (snap) => { if (!snap.exists() || scoresBeingEdited.size > 0) return; const d = snap.val(); state.players = d.players || []; state.teams = d.teams || []; state.rounds = d.rounds || []; state.currentRound = d.currentRound || 1; if (state.viewingRound > state.rounds.length) state.viewingRound = state.currentRound; renderTournament(); }); }
        
        function copyCode() { navigator.clipboard.writeText(state.tournamentId?.toUpperCase() || '').then(() => showToast('üìã Code copied!')); }
        function shareLink() { const url = window.location.href; if (navigator.share) navigator.share({ title: state.tournamentName, url }); else navigator.clipboard.writeText(url).then(() => showToast('üìã Link copied!')); }
        
        document.addEventListener('DOMContentLoaded', handleRoute);
        window.addEventListener('hashchange', handleRoute);
    </script>
</body>
</html>
