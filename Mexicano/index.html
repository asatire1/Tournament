<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mexicano - Stretford Padel</title>
    <meta name="description" content="Mexicano padel tournament manager with dynamic matchups">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        teal: {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            200: '#99f6e4',
                            300: '#5eead4',
                            400: '#2dd4bf',
                            500: '#14b8a6',
                            600: '#0d9488',
                            700: '#0f766e',
                            800: '#115e59',
                            900: '#134e4a',
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            font-family: 'Space Grotesk', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        /* Animations */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes bounce-in {
            0% { transform: scale(0.9); opacity: 0; }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-100px) rotate(720deg); opacity: 0; }
        }
        
        .animate-fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }
        .animate-bounce-in { animation: bounce-in 0.4s ease-out forwards; }
        
        /* Mode Toggle */
        .mode-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid #e5e7eb;
        }
        
        .mode-card:hover {
            border-color: #99f6e4;
            transform: translateY(-2px);
        }
        
        .mode-card.selected {
            border-color: #14b8a6;
            background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%);
            box-shadow: 0 4px 20px -4px rgba(20, 184, 166, 0.3);
        }
        
        .mode-card.selected .mode-icon { transform: scale(1.1); }
        
        /* Points Selector */
        .points-option {
            transition: all 0.2s ease;
            border: 2px solid #e5e7eb;
        }
        
        .points-option:hover { border-color: #99f6e4; }
        
        .points-option.selected {
            border-color: #14b8a6;
            background: #f0fdfa;
        }
        
        /* Input styling */
        .input-field { transition: all 0.2s ease; }
        
        .input-field:focus {
            border-color: #14b8a6;
            box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
        }
        
        /* Button */
        .btn-primary {
            background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px -4px rgba(20, 184, 166, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Screen transitions */
        .screen { display: none; }
        .screen.active { display: block; animation: fadeIn 0.3s ease-out; }
        
        /* Match Card */
        .match-card {
            background: white;
            border-radius: 16px;
            border: 2px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        
        .match-card:hover { border-color: #99f6e4; }
        
        .match-card.completed {
            border-color: #14b8a6;
            background: linear-gradient(135deg, #f0fdfa 0%, #ffffff 100%);
        }
        
        /* Score Input */
        .score-input {
            width: 60px;
            height: 50px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            transition: all 0.2s ease;
        }
        
        .score-input:focus {
            outline: none;
            border-color: #14b8a6;
            box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
        }
        
        .score-input.valid {
            border-color: #14b8a6;
            background: #f0fdfa;
        }
        
        /* Tab Navigation */
        .tab-btn { transition: all 0.2s ease; }
        
        .tab-btn.active {
            background: white;
            color: #0d9488;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* Round Selector */
        .round-btn {
            transition: all 0.2s ease;
        }
        
        .round-btn.active {
            background: #14b8a6;
            color: white;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Hero gradient */
        .hero-gradient {
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 50%, #06b6d4 100%);
        }
        
        /* Court badge */
        .court-badge {
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
        }
        
        /* Winner card */
        .winner-card {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
        }
        
        /* Modal */
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    
    <!-- ===== HEADER ===== -->
    <header class="hero-gradient text-white sticky top-0 z-40 shadow-lg">
        <div class="max-w-2xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <a href="../" class="flex items-center gap-3 hover:opacity-80 transition-opacity">
                    <span class="text-2xl">üéØ</span>
                    <div>
                        <h1 class="text-xl font-bold leading-tight">Mexicano</h1>
                        <p class="text-xs text-teal-100 opacity-90">Dynamic Matchups</p>
                    </div>
                </a>
                
                <div id="header-code" class="hidden">
                    <div class="bg-white/20 backdrop-blur-sm rounded-lg px-3 py-1.5 flex items-center gap-2">
                        <span class="text-xs text-teal-100">Code:</span>
                        <span id="header-code-value" class="font-mono font-bold tracking-wider"></span>
                        <button onclick="copyTournamentCode()" class="text-teal-100 hover:text-white transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <!-- ===== MAIN CONTENT ===== -->
    <main class="max-w-2xl mx-auto px-4 py-6">
        
        <!-- ===== SCREEN: SETUP ===== -->
        <div id="screen-setup" class="screen active">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-6 animate-fade-in-up">
                <div class="text-center mb-6">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-br from-teal-500 to-cyan-500 text-3xl mb-4 shadow-lg shadow-teal-500/30">
                        üéØ
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Create Mexicano Tournament</h2>
                    <p class="text-gray-500">Dynamic matchups based on standings</p>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Tournament Name</label>
                    <input type="text" id="tournament-name" class="input-field w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none text-lg" placeholder="Friday Night Mexicano" maxlength="40" />
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Tournament Mode</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="mode-card rounded-xl p-4 cursor-pointer selected" data-mode="individual" onclick="selectMode('individual')">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="mode-icon w-10 h-10 rounded-xl bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center text-xl transition-transform">üîÑ</div>
                                <div>
                                    <h3 class="font-bold text-gray-900">Individual</h3>
                                    <p class="text-xs text-gray-500">Rotating partners</p>
                                </div>
                            </div>
                            <p class="text-xs text-gray-600 leading-relaxed">Partners change each round based on standings.</p>
                        </div>
                        
                        <div class="mode-card rounded-xl p-4 cursor-pointer" data-mode="team" onclick="selectMode('team')">
                            <div class="flex items-center gap-3 mb-2">
                                <div class="mode-icon w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-500 to-cyan-600 flex items-center justify-center text-xl transition-transform">üëØ</div>
                                <div>
                                    <h3 class="font-bold text-gray-900">Team</h3>
                                    <p class="text-xs text-gray-500">Fixed partners</p>
                                </div>
                            </div>
                            <p class="text-xs text-gray-600 leading-relaxed">Stay with your partner all tournament.</p>
                        </div>
                    </div>
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-3">Points Per Match</label>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="points-option rounded-xl p-4 text-center cursor-pointer" data-points="16" onclick="selectPoints(16)">
                            <div class="text-2xl font-bold text-gray-900">16</div>
                            <div class="text-xs text-gray-500">~8 min</div>
                        </div>
                        <div class="points-option rounded-xl p-4 text-center cursor-pointer selected" data-points="24" onclick="selectPoints(24)">
                            <div class="text-2xl font-bold text-gray-900">24</div>
                            <div class="text-xs text-gray-500">~12 min</div>
                        </div>
                        <div class="points-option rounded-xl p-4 text-center cursor-pointer" data-points="32" onclick="selectPoints(32)">
                            <div class="text-2xl font-bold text-gray-900">32</div>
                            <div class="text-xs text-gray-500">~16 min</div>
                        </div>
                    </div>
                </div>
                
                <button id="btn-continue-setup" onclick="continueToPlayers()" class="btn-primary w-full py-4 rounded-xl text-white font-semibold text-lg flex items-center justify-center gap-2">
                    Continue
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                    </svg>
                </button>
            </div>
            
            <div class="bg-gradient-to-br from-teal-50 to-cyan-50 rounded-2xl p-5 border border-teal-100">
                <h3 class="font-bold text-teal-900 mb-3 flex items-center gap-2">
                    <span>üìñ</span> How Mexicano Works
                </h3>
                <div class="space-y-2 text-sm text-teal-800">
                    <div class="flex items-start gap-2">
                        <span class="text-teal-500 mt-0.5">‚Ä¢</span>
                        <span><strong>Round 1:</strong> Random lottery decides pairings</span>
                    </div>
                    <div class="flex items-start gap-2">
                        <span class="text-teal-500 mt-0.5">‚Ä¢</span>
                        <span><strong>Round 2+:</strong> Standings determine matchups ‚Äî #1 & #3 vs #2 & #4</span>
                    </div>
                    <div class="flex items-start gap-2">
                        <span class="text-teal-500 mt-0.5">‚Ä¢</span>
                        <span>Better players face tougher opponents ‚Äî balanced matches!</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ===== SCREEN: PLAYERS ===== -->
        <div id="screen-players" class="screen">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4" id="players-screen-title">Add Players</h2>
                <p class="text-gray-500 mb-6" id="players-screen-subtitle">Minimum 8 players required</p>
                
                <div id="players-input-area"></div>
                <div id="players-list" class="space-y-2 mb-6"></div>
                
                <div class="flex gap-3">
                    <button onclick="backToSetup()" class="flex-1 py-3 rounded-xl border-2 border-gray-200 text-gray-700 font-semibold hover:bg-gray-50 transition-colors">Back</button>
                    <button id="btn-start-tournament" onclick="startTournament()" class="btn-primary flex-1 py-3 rounded-xl text-white font-semibold disabled:opacity-50" disabled>Start Tournament</button>
                </div>
            </div>
        </div>
        
        <!-- ===== SCREEN: TOURNAMENT ===== -->
        <div id="screen-tournament" class="screen">
            
            <!-- Tournament Header -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-4 mb-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 id="tournament-title" class="text-xl font-bold text-gray-900">Tournament</h2>
                        <p id="tournament-meta" class="text-sm text-gray-500">Individual ‚Ä¢ 24 points/match</p>
                    </div>
                    <div id="round-badge" class="inline-flex items-center gap-2 bg-teal-100 text-teal-800 px-3 py-1 rounded-full text-sm font-semibold">
                        Round 1
                    </div>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <div class="bg-gray-100 rounded-xl p-1 flex gap-1 mb-4">
                <button class="tab-btn flex-1 py-2 px-4 rounded-lg text-sm font-semibold text-gray-600 active" data-tab="matches" onclick="switchTab('matches')">üéæ Matches</button>
                <button class="tab-btn flex-1 py-2 px-4 rounded-lg text-sm font-semibold text-gray-600" data-tab="standings" onclick="switchTab('standings')">üèÜ Standings</button>
                <button class="tab-btn flex-1 py-2 px-4 rounded-lg text-sm font-semibold text-gray-600" data-tab="settings" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
            </div>
            
            <!-- Tab Content: Matches -->
            <div id="tab-matches" class="tab-content">
                <!-- Round Selector -->
                <div id="round-selector" class="flex gap-2 mb-4 overflow-x-auto pb-2"></div>
                
                <div id="matches-container" class="space-y-4"></div>
                
                <div id="complete-round-container" class="mt-6 hidden">
                    <button id="btn-complete-round" onclick="completeRound()" class="btn-primary w-full py-4 rounded-xl text-white font-semibold text-lg flex items-center justify-center gap-2">
                        Complete Round & Generate Next
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Tab Content: Standings -->
            <div id="tab-standings" class="tab-content hidden">
                <div id="standings-container" class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden"></div>
            </div>
            
            <!-- Tab Content: Settings -->
            <div id="tab-settings" class="tab-content hidden">
                <div class="space-y-4">
                    <!-- Share Section -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5">
                        <h3 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <span>üîó</span> Share Tournament
                        </h3>
                        
                        <div class="bg-gray-50 rounded-xl p-4 mb-4">
                            <div class="text-center">
                                <div class="text-xs text-gray-500 mb-1">Tournament Code</div>
                                <div id="settings-code" class="text-3xl font-mono font-bold text-teal-600 tracking-widest"></div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="copyTournamentCode()" class="flex items-center justify-center gap-2 py-3 bg-gray-100 hover:bg-gray-200 rounded-xl font-medium transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                </svg>
                                Copy Code
                            </button>
                            <button onclick="shareLink()" class="flex items-center justify-center gap-2 py-3 bg-teal-100 hover:bg-teal-200 text-teal-700 rounded-xl font-medium transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                                </svg>
                                Share Link
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tournament Info -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5">
                        <h3 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <span>üìä</span> Tournament Info
                        </h3>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-500">Mode</span>
                                <span id="info-mode" class="font-medium text-gray-900">Individual</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-500">Points per Match</span>
                                <span id="info-points" class="font-medium text-gray-900">24</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-500">Players/Teams</span>
                                <span id="info-count" class="font-medium text-gray-900">8</span>
                            </div>
                            <div class="flex justify-between py-2 border-b border-gray-100">
                                <span class="text-gray-500">Current Round</span>
                                <span id="info-round" class="font-medium text-gray-900">1</span>
                            </div>
                            <div class="flex justify-between py-2">
                                <span class="text-gray-500">Status</span>
                                <span id="info-status" class="font-medium text-teal-600">Active</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- End Tournament -->
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5">
                        <h3 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <span>üèÅ</span> End Tournament
                        </h3>
                        <p class="text-sm text-gray-500 mb-4">End the tournament and declare the winner based on current standings.</p>
                        <button onclick="confirmEndTournament()" class="w-full py-3 bg-red-50 hover:bg-red-100 text-red-600 rounded-xl font-semibold transition-colors">
                            End Tournament
                        </button>
                    </div>
                </div>
            </div>
            
        </div>
        
        <!-- ===== SCREEN: COMPLETED ===== -->
        <div id="screen-completed" class="screen">
            <div class="text-center py-8">
                <div class="text-6xl mb-4">üèÜ</div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Tournament Complete!</h2>
                <p id="winner-name" class="text-xl text-teal-600 font-semibold mb-6"></p>
            </div>
            
            <div id="final-standings" class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-6"></div>
            
            <button onclick="window.location.href='../'" class="btn-primary w-full py-4 rounded-xl text-white font-semibold text-lg">
                Back to Home
            </button>
        </div>
        
    </main>
    
    <!-- ===== EDIT SCORE MODAL ===== -->
    <div id="edit-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeEditModal()"></div>
        <div class="absolute inset-x-4 top-1/2 -translate-y-1/2 max-w-md mx-auto">
            <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
                <div class="bg-gradient-to-r from-teal-600 to-teal-500 px-6 py-4">
                    <h3 class="text-lg font-bold text-white">Edit Match Score</h3>
                </div>
                <div class="p-6">
                    <div id="edit-match-info" class="mb-4 text-center text-gray-600"></div>
                    
                    <div class="flex items-center justify-center gap-4 mb-6">
                        <div class="text-center">
                            <div id="edit-team1-names" class="text-sm font-medium text-gray-700 mb-2"></div>
                            <input type="number" id="edit-score1" class="score-input" min="0" />
                        </div>
                        <span class="text-2xl text-gray-400 font-bold">-</span>
                        <div class="text-center">
                            <div id="edit-team2-names" class="text-sm font-medium text-gray-700 mb-2"></div>
                            <input type="number" id="edit-score2" class="score-input" min="0" />
                        </div>
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="closeEditModal()" class="flex-1 py-3 rounded-xl border-2 border-gray-200 text-gray-700 font-semibold hover:bg-gray-50">Cancel</button>
                        <button onclick="saveEditedScore()" class="btn-primary flex-1 py-3 rounded-xl text-white font-semibold">Save</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ===== CONFIRM END MODAL ===== -->
    <div id="confirm-end-modal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeConfirmEndModal()"></div>
        <div class="absolute inset-x-4 top-1/2 -translate-y-1/2 max-w-md mx-auto">
            <div class="bg-white rounded-2xl shadow-2xl overflow-hidden">
                <div class="bg-gradient-to-r from-red-600 to-red-500 px-6 py-4">
                    <h3 class="text-lg font-bold text-white">End Tournament?</h3>
                </div>
                <div class="p-6">
                    <p class="text-gray-600 mb-6">Are you sure you want to end this tournament? The winner will be declared based on current standings.</p>
                    
                    <div class="flex gap-3">
                        <button onclick="closeConfirmEndModal()" class="flex-1 py-3 rounded-xl border-2 border-gray-200 text-gray-700 font-semibold hover:bg-gray-50">Cancel</button>
                        <button onclick="endTournament()" class="flex-1 py-3 rounded-xl bg-red-500 hover:bg-red-600 text-white font-semibold transition-colors">End Tournament</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ===== TOAST CONTAINER ===== -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50"></div>
    
    <!-- ===== JAVASCRIPT ===== -->
    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyDYIlRS_me7sy7ptNmRrvPQCeXP2H-hHzU",
            authDomain: "stretford-padel-tournament.firebaseapp.com",
            databaseURL: "https://stretford-padel-tournament-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "stretford-padel-tournament",
            storageBucket: "stretford-padel-tournament.firebasestorage.app",
            messagingSenderId: "596263602058",
            appId: "1:596263602058:web:f69f7f8d00c60abbd0aa73",
            measurementId: "G-TGJ6CZ4DZ0"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // ===== STATE =====
        const state = {
            tournamentId: null,
            tournamentName: '',
            mode: 'individual',
            pointsPerMatch: 24,
            players: [],
            teams: [],
            rounds: [],
            currentRound: 0,
            viewingRound: 0,
            status: 'setup',
            editingMatch: null
        };
        
        let scoresBeingEdited = new Set();
        
        // ===== MODE & POINTS SELECTION =====
        function selectMode(mode) {
            state.mode = mode;
            document.querySelectorAll('.mode-card').forEach(card => card.classList.remove('selected'));
            document.querySelector(`[data-mode="${mode}"]`).classList.add('selected');
        }
        
        function selectPoints(points) {
            state.pointsPerMatch = points;
            document.querySelectorAll('.points-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelector(`[data-points="${points}"]`).classList.add('selected');
        }
        
        // ===== SCREEN NAVIGATION =====
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(`screen-${screenId}`).classList.add('active');
            state.status = screenId;
        }
        
        // ===== TAB NAVIGATION =====
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            
            if (tabName === 'standings') renderStandings();
            if (tabName === 'settings') updateSettingsInfo();
        }
        
        // ===== SETUP FLOW =====
        function continueToPlayers() {
            const name = document.getElementById('tournament-name').value.trim();
            if (!name) {
                showToast('‚ö†Ô∏è Please enter a tournament name');
                return;
            }
            state.tournamentName = name;
            updatePlayersScreen();
            showScreen('players');
        }
        
        function backToSetup() { showScreen('setup'); }
        
        function updatePlayersScreen() {
            const title = document.getElementById('players-screen-title');
            const subtitle = document.getElementById('players-screen-subtitle');
            const inputArea = document.getElementById('players-input-area');
            
            if (state.mode === 'individual') {
                title.textContent = 'Add Players';
                subtitle.textContent = 'Minimum 8 players ‚Ä¢ Best if divisible by 4';
                inputArea.innerHTML = `
                    <div class="flex gap-2 mb-4">
                        <input type="text" id="player-name-input" class="input-field flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none" placeholder="Player name" maxlength="30" onkeypress="if(event.key==='Enter')addPlayer()" />
                        <button onclick="addPlayer()" class="px-5 py-3 bg-teal-500 hover:bg-teal-600 text-white rounded-xl font-semibold transition-colors">Add</button>
                    </div>
                `;
            } else {
                title.textContent = 'Add Teams';
                subtitle.textContent = 'Minimum 4 teams ‚Ä¢ Fixed partner pairs';
                inputArea.innerHTML = `
                    <div class="space-y-3 mb-4">
                        <div class="flex gap-2">
                            <input type="text" id="team-player1-input" class="input-field flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none" placeholder="Player 1" maxlength="30" />
                            <input type="text" id="team-player2-input" class="input-field flex-1 px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none" placeholder="Player 2" maxlength="30" onkeypress="if(event.key==='Enter')addTeam()" />
                        </div>
                        <button onclick="addTeam()" class="w-full py-3 bg-teal-500 hover:bg-teal-600 text-white rounded-xl font-semibold transition-colors">Add Team</button>
                    </div>
                `;
            }
            renderPlayersList();
        }
        
        function addPlayer() {
            const input = document.getElementById('player-name-input');
            const name = input.value.trim();
            if (!name) { showToast('‚ö†Ô∏è Please enter a player name'); return; }
            if (state.players.some(p => p.name.toLowerCase() === name.toLowerCase())) { showToast('‚ö†Ô∏è Player already added'); return; }
            state.players.push({ id: generateId(), name, totalPoints: 0, matchesPlayed: 0 });
            input.value = '';
            input.focus();
            renderPlayersList();
            updateStartButton();
        }
        
        function addTeam() {
            const input1 = document.getElementById('team-player1-input');
            const input2 = document.getElementById('team-player2-input');
            const p1 = input1.value.trim(), p2 = input2.value.trim();
            if (!p1 || !p2) { showToast('‚ö†Ô∏è Please enter both player names'); return; }
            state.teams.push({ id: generateId(), player1: p1, player2: p2, teamName: `${p1} & ${p2}`, totalPoints: 0, matchesPlayed: 0 });
            input1.value = ''; input2.value = '';
            input1.focus();
            renderPlayersList();
            updateStartButton();
        }
        
        function removePlayer(id) { state.players = state.players.filter(p => p.id !== id); renderPlayersList(); updateStartButton(); }
        function removeTeam(id) { state.teams = state.teams.filter(t => t.id !== id); renderPlayersList(); updateStartButton(); }
        
        function renderPlayersList() {
            const container = document.getElementById('players-list');
            const items = state.mode === 'individual' ? state.players : state.teams;
            
            if (items.length === 0) {
                container.innerHTML = `<div class="text-center py-8 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200"><div class="text-3xl mb-2 opacity-50">${state.mode === 'individual' ? 'üë§' : 'üëØ'}</div><p class="text-gray-500 text-sm">No ${state.mode === 'individual' ? 'players' : 'teams'} added yet</p></div>`;
                return;
            }
            
            container.innerHTML = items.map((item, i) => `
                <div class="flex items-center gap-3 bg-gray-50 rounded-xl px-4 py-3 animate-slide-in" style="animation-delay:${i*0.05}s">
                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center text-white font-bold text-sm">${i+1}</div>
                    <span class="flex-1 font-medium text-gray-900">${state.mode === 'individual' ? item.name : `${item.player1} & ${item.player2}`}</span>
                    <button onclick="remove${state.mode === 'individual' ? 'Player' : 'Team'}('${item.id}')" class="text-gray-400 hover:text-red-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
            `).join('');
        }
        
        function updateStartButton() {
            const btn = document.getElementById('btn-start-tournament');
            const count = state.mode === 'individual' ? state.players.length : state.teams.length;
            const min = state.mode === 'individual' ? 8 : 4;
            const valid = count >= min;
            btn.disabled = !valid;
            btn.textContent = valid ? `Start Tournament (${count} ${state.mode === 'individual' ? 'players' : 'teams'})` : `Add ${min - count} more`;
        }
        
        // ===== START TOURNAMENT =====
        async function startTournament() {
            const btn = document.getElementById('btn-start-tournament');
            btn.disabled = true;
            btn.textContent = 'Creating...';
            
            try {
                const tournamentId = generateTournamentCode();
                state.tournamentId = tournamentId;
                state.rounds = [generateRound(1)];
                state.currentRound = 1;
                state.viewingRound = 1;
                
                const data = {
                    meta: { name: state.tournamentName, mode: state.mode, pointsPerMatch: state.pointsPerMatch, createdAt: new Date().toISOString(), updatedAt: new Date().toISOString(), status: 'active' },
                    currentRound: 1,
                    playerCount: state.mode === 'individual' ? state.players.length : state.teams.length * 2,
                    rounds: state.rounds
                };
                
                if (state.mode === 'individual') data.players = state.players;
                else data.teams = state.teams;
                
                await database.ref(`mexicano/${tournamentId}`).set(data);
                window.location.hash = `/t/${tournamentId}`;
                
                document.getElementById('header-code').classList.remove('hidden');
                document.getElementById('header-code-value').textContent = tournamentId.toUpperCase();
                
                showToast('‚úÖ Tournament created!');
                renderTournamentScreen();
                showScreen('tournament');
            } catch (e) {
                console.error(e);
                showToast('‚ùå Error creating tournament');
                btn.disabled = false;
            }
        }
        
        // ===== ROUND GENERATION =====
        function generateRound(roundNumber) {
            return state.mode === 'individual' ? generateIndividualRound(roundNumber) : generateTeamRound(roundNumber);
        }
        
        function generateIndividualRound(roundNumber) {
            let sorted = roundNumber === 1 ? shuffleArray([...state.players]) : [...state.players].sort((a,b) => b.totalPoints - a.totalPoints || a.matchesPlayed - b.matchesPlayed);
            
            const matches = [];
            const numCourts = Math.floor(sorted.length / 4);
            
            for (let c = 0; c < numCourts; c++) {
                const base = c * 4;
                const t1 = [sorted[base], sorted[base + 2]];
                const t2 = [sorted[base + 1], sorted[base + 3]];
                matches.push({ id: generateId(), court: c + 1, team1: t1.map(p => p.id), team1Names: t1.map(p => p.name), team2: t2.map(p => p.id), team2Names: t2.map(p => p.name), score1: null, score2: null, completed: false });
            }
            
            return { roundNumber, matches, sittingOut: sorted.slice(numCourts * 4).map(p => p.id), completed: false };
        }
        
        function generateTeamRound(roundNumber) {
            let sorted = roundNumber === 1 ? shuffleArray([...state.teams]) : [...state.teams].sort((a,b) => b.totalPoints - a.totalPoints || a.matchesPlayed - b.matchesPlayed);
            
            const matches = [];
            const numMatches = Math.floor(sorted.length / 2);
            
            for (let i = 0; i < numMatches; i++) {
                const t1 = sorted[i * 2], t2 = sorted[i * 2 + 1];
                matches.push({ id: generateId(), court: i + 1, team1: t1.id, team1Name: t1.teamName, team1Players: [t1.player1, t1.player2], team2: t2.id, team2Name: t2.teamName, team2Players: [t2.player1, t2.player2], score1: null, score2: null, completed: false });
            }
            
            return { roundNumber, matches, sittingOut: sorted.length % 2 ? [sorted[sorted.length - 1].id] : [], completed: false };
        }
        
        // ===== RENDER TOURNAMENT =====
        function renderTournamentScreen() {
            document.getElementById('tournament-title').textContent = state.tournamentName;
            document.getElementById('tournament-meta').textContent = `${state.mode === 'individual' ? 'Individual' : 'Team'} ‚Ä¢ ${state.pointsPerMatch} pts/match`;
            document.getElementById('round-badge').textContent = `Round ${state.currentRound}`;
            renderRoundSelector();
            renderMatches();
            renderStandings();
        }
        
        function renderRoundSelector() {
            const container = document.getElementById('round-selector');
            container.innerHTML = state.rounds.map((r, i) => `
                <button class="round-btn px-4 py-2 rounded-lg text-sm font-semibold ${state.viewingRound === i + 1 ? 'active' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'} transition-colors" onclick="viewRound(${i + 1})">
                    Round ${i + 1}
                </button>
            `).join('');
        }
        
        function viewRound(roundNum) {
            state.viewingRound = roundNum;
            renderRoundSelector();
            renderMatches();
        }
        
        function renderMatches() {
            const container = document.getElementById('matches-container');
            const round = state.rounds[state.viewingRound - 1];
            if (!round) { container.innerHTML = '<p class="text-center text-gray-500 py-8">No matches</p>'; return; }
            
            const isCurrentRound = state.viewingRound === state.currentRound;
            
            container.innerHTML = round.matches.map((m, i) => `
                <div class="match-card p-4 ${m.completed ? 'completed' : ''} animate-bounce-in" style="animation-delay:${i*0.1}s">
                    <div class="flex items-center justify-between mb-3">
                        <div class="court-badge text-white text-xs font-bold px-2 py-1 rounded-lg">Court ${m.court}</div>
                        <div class="flex items-center gap-2">
                            ${m.completed ? '<span class="text-teal-600 text-xs font-semibold">‚úì Complete</span>' : ''}
                            ${m.completed ? `<button onclick="openEditModal('${m.id}')" class="text-gray-400 hover:text-teal-600 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg></button>` : ''}
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-4">
                        <div class="flex-1 text-right">
                            ${state.mode === 'individual' ? m.team1Names.map(n => `<div class="font-semibold text-gray-900">${n}</div>`).join('') : m.team1Players.map(n => `<div class="font-semibold text-gray-900">${n}</div>`).join('')}
                        </div>
                        
                        <div class="flex items-center gap-2">
                            ${isCurrentRound && !m.completed ? `
                                <input type="number" min="0" max="${state.pointsPerMatch}" class="score-input" value="${m.score1 !== null ? m.score1 : ''}" onfocus="onScoreFocus('${m.id}')" onblur="onScoreBlur('${m.id}',1,this.value)" oninput="onScoreInput('${m.id}',1,this.value)" />
                                <span class="text-gray-400 font-bold">-</span>
                                <input type="number" min="0" max="${state.pointsPerMatch}" class="score-input" value="${m.score2 !== null ? m.score2 : ''}" onfocus="onScoreFocus('${m.id}')" onblur="onScoreBlur('${m.id}',2,this.value)" oninput="onScoreInput('${m.id}',2,this.value)" />
                            ` : `
                                <div class="score-input flex items-center justify-center ${m.completed ? 'valid' : ''}">${m.score1 !== null ? m.score1 : '-'}</div>
                                <span class="text-gray-400 font-bold">-</span>
                                <div class="score-input flex items-center justify-center ${m.completed ? 'valid' : ''}">${m.score2 !== null ? m.score2 : '-'}</div>
                            `}
                        </div>
                        
                        <div class="flex-1 text-left">
                            ${state.mode === 'individual' ? m.team2Names.map(n => `<div class="font-semibold text-gray-900">${n}</div>`).join('') : m.team2Players.map(n => `<div class="font-semibold text-gray-900">${n}</div>`).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Sitting out
            if (round.sittingOut?.length) {
                const names = round.sittingOut.map(id => {
                    if (state.mode === 'individual') return state.players.find(p => p.id === id)?.name || 'Unknown';
                    return state.teams.find(t => t.id === id)?.teamName || 'Unknown';
                });
                container.innerHTML += `<div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mt-4"><div class="flex items-center gap-2 text-amber-800"><span>‚è≥</span><span class="font-medium">Sitting out:</span><span>${names.join(', ')}</span></div></div>`;
            }
            
            checkRoundCompletion();
        }
        
        // ===== SCORE HANDLING =====
        function onScoreFocus(matchId) { scoresBeingEdited.add(matchId); }
        
        function onScoreInput(matchId, team, value) {
            const round = state.rounds[state.currentRound - 1];
            const match = round?.matches.find(m => m.id === matchId);
            if (!match || match.completed) return;
            if (team === 1) match.score1 = value === '' ? null : parseInt(value);
            else match.score2 = value === '' ? null : parseInt(value);
        }
        
        async function onScoreBlur(matchId, team, value) {
            scoresBeingEdited.delete(matchId);
            const round = state.rounds[state.currentRound - 1];
            const match = round?.matches.find(m => m.id === matchId);
            if (!match || match.completed) return;
            
            const score = value === '' ? null : parseInt(value);
            if (team === 1) match.score1 = score;
            else match.score2 = score;
            
            if (match.score1 !== null && match.score2 !== null) {
                const total = match.score1 + match.score2;
                if (total === state.pointsPerMatch) {
                    match.completed = true;
                    updatePoints(match, match.score1, match.score2);
                    showToast('‚úÖ Match saved!');
                } else if (total > state.pointsPerMatch) {
                    showToast(`‚ö†Ô∏è Total must equal ${state.pointsPerMatch}`);
                }
            }
            
            await saveToFirebase();
            renderMatches();
            renderStandings();
        }
        
        function updatePoints(match, score1, score2) {
            if (state.mode === 'individual') {
                match.team1.forEach(id => {
                    const p = state.players.find(x => x.id === id);
                    if (p) { p.totalPoints += score1; p.matchesPlayed++; }
                });
                match.team2.forEach(id => {
                    const p = state.players.find(x => x.id === id);
                    if (p) { p.totalPoints += score2; p.matchesPlayed++; }
                });
            } else {
                const t1 = state.teams.find(t => t.id === match.team1);
                const t2 = state.teams.find(t => t.id === match.team2);
                if (t1) { t1.totalPoints += score1; t1.matchesPlayed++; }
                if (t2) { t2.totalPoints += score2; t2.matchesPlayed++; }
            }
        }
        
        function revertPoints(match) {
            if (state.mode === 'individual') {
                match.team1.forEach(id => {
                    const p = state.players.find(x => x.id === id);
                    if (p) { p.totalPoints -= match.score1; p.matchesPlayed--; }
                });
                match.team2.forEach(id => {
                    const p = state.players.find(x => x.id === id);
                    if (p) { p.totalPoints -= match.score2; p.matchesPlayed--; }
                });
            } else {
                const t1 = state.teams.find(t => t.id === match.team1);
                const t2 = state.teams.find(t => t.id === match.team2);
                if (t1) { t1.totalPoints -= match.score1; t1.matchesPlayed--; }
                if (t2) { t2.totalPoints -= match.score2; t2.matchesPlayed--; }
            }
        }
        
        function checkRoundCompletion() {
            const round = state.rounds[state.currentRound - 1];
            const allComplete = round?.matches.every(m => m.completed);
            const container = document.getElementById('complete-round-container');
            if (allComplete && state.viewingRound === state.currentRound) container.classList.remove('hidden');
            else container.classList.add('hidden');
        }
        
        async function completeRound() {
            state.rounds[state.currentRound - 1].completed = true;
            const nextRound = generateRound(state.currentRound + 1);
            state.rounds.push(nextRound);
            state.currentRound++;
            state.viewingRound = state.currentRound;
            
            await saveToFirebase();
            document.getElementById('round-badge').textContent = `Round ${state.currentRound}`;
            showToast(`üéØ Round ${state.currentRound} generated!`);
            renderRoundSelector();
            renderMatches();
            renderStandings();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // ===== EDIT SCORE MODAL =====
        function openEditModal(matchId) {
            const round = state.rounds.find(r => r.matches.some(m => m.id === matchId));
            const match = round?.matches.find(m => m.id === matchId);
            if (!match) return;
            
            state.editingMatch = { matchId, roundIndex: round.roundNumber - 1 };
            
            document.getElementById('edit-match-info').textContent = `Round ${round.roundNumber}, Court ${match.court}`;
            document.getElementById('edit-team1-names').textContent = state.mode === 'individual' ? match.team1Names.join(' & ') : match.team1Players.join(' & ');
            document.getElementById('edit-team2-names').textContent = state.mode === 'individual' ? match.team2Names.join(' & ') : match.team2Players.join(' & ');
            document.getElementById('edit-score1').value = match.score1;
            document.getElementById('edit-score2').value = match.score2;
            document.getElementById('edit-score1').max = state.pointsPerMatch;
            document.getElementById('edit-score2').max = state.pointsPerMatch;
            
            document.getElementById('edit-modal').classList.remove('hidden');
        }
        
        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
            state.editingMatch = null;
        }
        
        async function saveEditedScore() {
            if (!state.editingMatch) return;
            
            const { matchId, roundIndex } = state.editingMatch;
            const match = state.rounds[roundIndex].matches.find(m => m.id === matchId);
            if (!match) return;
            
            const newScore1 = parseInt(document.getElementById('edit-score1').value);
            const newScore2 = parseInt(document.getElementById('edit-score2').value);
            
            if (isNaN(newScore1) || isNaN(newScore2) || newScore1 + newScore2 !== state.pointsPerMatch) {
                showToast(`‚ö†Ô∏è Scores must total ${state.pointsPerMatch}`);
                return;
            }
            
            // Revert old points
            revertPoints(match);
            
            // Apply new scores
            match.score1 = newScore1;
            match.score2 = newScore2;
            updatePoints(match, newScore1, newScore2);
            
            await saveToFirebase();
            closeEditModal();
            showToast('‚úÖ Score updated!');
            renderMatches();
            renderStandings();
        }
        
        // ===== STANDINGS =====
        function renderStandings() {
            const container = document.getElementById('standings-container');
            const items = state.mode === 'individual' ? [...state.players].sort((a,b) => b.totalPoints - a.totalPoints) : [...state.teams].sort((a,b) => b.totalPoints - a.totalPoints);
            
            container.innerHTML = `
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="text-left py-3 px-4 text-xs font-semibold text-gray-500 uppercase">#</th>
                            <th class="text-left py-3 px-4 text-xs font-semibold text-gray-500 uppercase">${state.mode === 'individual' ? 'Player' : 'Team'}</th>
                            <th class="text-center py-3 px-4 text-xs font-semibold text-gray-500 uppercase">Played</th>
                            <th class="text-right py-3 px-4 text-xs font-semibold text-gray-500 uppercase">Points</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        ${items.map((item, i) => `
                            <tr class="${i < 3 ? 'bg-teal-50/50' : ''}">
                                <td class="py-3 px-4"><span class="${i < 3 ? 'font-bold text-teal-600' : 'text-gray-500'}">${i + 1}</span></td>
                                <td class="py-3 px-4"><span class="font-medium text-gray-900">${state.mode === 'individual' ? item.name : `${item.player1} & ${item.player2}`}</span></td>
                                <td class="py-3 px-4 text-center text-gray-500">${item.matchesPlayed}</td>
                                <td class="py-3 px-4 text-right"><span class="font-bold ${i < 3 ? 'text-teal-600' : 'text-gray-900'}">${item.totalPoints}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        // ===== SETTINGS =====
        function updateSettingsInfo() {
            document.getElementById('settings-code').textContent = state.tournamentId?.toUpperCase() || '';
            document.getElementById('info-mode').textContent = state.mode === 'individual' ? 'Individual' : 'Team';
            document.getElementById('info-points').textContent = state.pointsPerMatch;
            document.getElementById('info-count').textContent = state.mode === 'individual' ? state.players.length : state.teams.length;
            document.getElementById('info-round').textContent = state.currentRound;
            document.getElementById('info-status').textContent = state.status === 'completed' ? 'Completed' : 'Active';
        }
        
        function shareLink() {
            const url = window.location.href;
            if (navigator.share) {
                navigator.share({ title: state.tournamentName, url });
            } else {
                navigator.clipboard.writeText(url).then(() => showToast('üìã Link copied!'));
            }
        }
        
        // ===== END TOURNAMENT =====
        function confirmEndTournament() {
            document.getElementById('confirm-end-modal').classList.remove('hidden');
        }
        
        function closeConfirmEndModal() {
            document.getElementById('confirm-end-modal').classList.add('hidden');
        }
        
        async function endTournament() {
            closeConfirmEndModal();
            
            state.status = 'completed';
            await database.ref(`mexicano/${state.tournamentId}/meta/status`).set('completed');
            
            const items = state.mode === 'individual' ? [...state.players].sort((a,b) => b.totalPoints - a.totalPoints) : [...state.teams].sort((a,b) => b.totalPoints - a.totalPoints);
            const winner = items[0];
            
            document.getElementById('winner-name').textContent = state.mode === 'individual' ? `ü•á ${winner.name} wins with ${winner.totalPoints} points!` : `ü•á ${winner.player1} & ${winner.player2} win with ${winner.totalPoints} points!`;
            
            // Final standings
            document.getElementById('final-standings').innerHTML = `
                <table class="w-full">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="text-left py-3 px-4 text-xs font-semibold text-gray-500 uppercase">#</th>
                            <th class="text-left py-3 px-4 text-xs font-semibold text-gray-500 uppercase">${state.mode === 'individual' ? 'Player' : 'Team'}</th>
                            <th class="text-right py-3 px-4 text-xs font-semibold text-gray-500 uppercase">Points</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        ${items.map((item, i) => `
                            <tr class="${i === 0 ? 'bg-yellow-50' : i < 3 ? 'bg-teal-50/50' : ''}">
                                <td class="py-3 px-4"><span class="${i === 0 ? 'text-yellow-600' : i < 3 ? 'text-teal-600' : 'text-gray-500'} font-bold">${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : i + 1}</span></td>
                                <td class="py-3 px-4"><span class="font-medium text-gray-900">${state.mode === 'individual' ? item.name : `${item.player1} & ${item.player2}`}</span></td>
                                <td class="py-3 px-4 text-right"><span class="font-bold">${item.totalPoints}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            showScreen('completed');
            showToast('üèÜ Tournament complete!');
        }
        
        // ===== FIREBASE =====
        async function saveToFirebase() {
            if (!state.tournamentId) return;
            try {
                const updates = { 'meta/updatedAt': new Date().toISOString(), currentRound: state.currentRound, rounds: state.rounds };
                if (state.mode === 'individual') updates.players = state.players;
                else updates.teams = state.teams;
                await database.ref(`mexicano/${state.tournamentId}`).update(updates);
            } catch (e) { console.error(e); showToast('‚ùå Error saving'); }
        }
        
        function copyTournamentCode() {
            navigator.clipboard.writeText(state.tournamentId?.toUpperCase() || '').then(() => showToast('üìã Code copied!'));
        }
        
        // ===== UTILITIES =====
        function generateId() { return Math.random().toString(36).substring(2, 9); }
        function generateTournamentCode() {
            const chars = 'abcdefghjkmnpqrstuvwxyz23456789';
            return Array.from({ length: 6 }, () => chars[Math.floor(Math.random() * chars.length)]).join('');
        }
        function shuffleArray(arr) {
            const a = [...arr];
            for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; }
            return a;
        }
        function showToast(msg) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'bg-gray-800 text-white px-4 py-3 rounded-xl shadow-lg mb-2 animate-fade-in-up';
            toast.textContent = msg;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.3s'; setTimeout(() => toast.remove(), 300); }, 3000);
        }
        
        // ===== ROUTING =====
        async function handleRoute() {
            const match = window.location.hash.match(/\/t\/([a-zA-Z0-9]+)/);
            if (match) await loadTournament(match[1].toLowerCase());
            else showScreen('setup');
        }
        
        async function loadTournament(tournamentId) {
            try {
                const snapshot = await database.ref(`mexicano/${tournamentId}`).once('value');
                if (!snapshot.exists()) { showToast('‚ùå Tournament not found'); window.location.hash = ''; showScreen('setup'); return; }
                
                const data = snapshot.val();
                state.tournamentId = tournamentId;
                state.tournamentName = data.meta.name;
                state.mode = data.meta.mode;
                state.pointsPerMatch = data.meta.pointsPerMatch;
                state.players = data.players || [];
                state.teams = data.teams || [];
                state.rounds = data.rounds || [];
                state.currentRound = data.currentRound || 1;
                state.viewingRound = state.currentRound;
                state.status = data.meta.status;
                
                document.getElementById('header-code').classList.remove('hidden');
                document.getElementById('header-code-value').textContent = tournamentId.toUpperCase();
                
                if (state.status === 'completed') {
                    const items = state.mode === 'individual' ? [...state.players].sort((a,b) => b.totalPoints - a.totalPoints) : [...state.teams].sort((a,b) => b.totalPoints - a.totalPoints);
                    const winner = items[0];
                    document.getElementById('winner-name').textContent = state.mode === 'individual' ? `ü•á ${winner.name} wins with ${winner.totalPoints} points!` : `ü•á ${winner.player1} & ${winner.player2} win with ${winner.totalPoints} points!`;
                    document.getElementById('final-standings').innerHTML = `<table class="w-full"><thead class="bg-gray-50"><tr><th class="text-left py-3 px-4 text-xs">#</th><th class="text-left py-3 px-4 text-xs">${state.mode === 'individual' ? 'Player' : 'Team'}</th><th class="text-right py-3 px-4 text-xs">Points</th></tr></thead><tbody>${items.map((item, i) => `<tr class="${i < 3 ? 'bg-teal-50/50' : ''}"><td class="py-3 px-4 font-bold">${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : i + 1}</td><td class="py-3 px-4 font-medium">${state.mode === 'individual' ? item.name : item.player1 + ' & ' + item.player2}</td><td class="py-3 px-4 text-right font-bold">${item.totalPoints}</td></tr>`).join('')}</tbody></table>`;
                    showScreen('completed');
                } else {
                    renderTournamentScreen();
                    showScreen('tournament');
                    setupRealtimeListener(tournamentId);
                }
            } catch (e) { console.error(e); showToast('‚ùå Error loading'); showScreen('setup'); }
        }
        
        function setupRealtimeListener(tournamentId) {
            database.ref(`mexicano/${tournamentId}`).on('value', (snapshot) => {
                if (!snapshot.exists() || scoresBeingEdited.size > 0) return;
                const data = snapshot.val();
                state.players = data.players || [];
                state.teams = data.teams || [];
                state.rounds = data.rounds || [];
                state.currentRound = data.currentRound || 1;
                if (state.viewingRound > state.rounds.length) state.viewingRound = state.currentRound;
                document.getElementById('round-badge').textContent = `Round ${state.currentRound}`;
                renderRoundSelector();
                renderMatches();
                renderStandings();
            });
        }
        
        // ===== INIT =====
        document.addEventListener('DOMContentLoaded', handleRoute);
        window.addEventListener('hashchange', handleRoute);
    </script>
</body>
</html>
